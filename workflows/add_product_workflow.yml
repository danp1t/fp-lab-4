name: "Добавление товара в интернет-магазин"
include_configs:
  - "workflows/configs/api_config.yaml"
  - "workflows/configs/test_data.yaml"

steps:
  - id: "check_permissions"
    type: "task"
    name: "Проверка прав доступа"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/accounts/{{account_id}}/detail"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "user_details"

  - id: "create_product"
    type: "task"
    name: "Создание товара"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "POST"
      url: "{{base_url}}/api/products"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
      body:
        name: "{{test_product.name}} #{timestamp}"
        description: "{{test_product.description}}"
        category: "{{test_product.category}}"
        basePrice: "{{test_product.base_price}}"
        popularity: 0
    on_success:
      save_response: "product_response"

  - id: "add_product_variants"
    type: "parallel"
    name: "Добавление вариантов товара"
    steps:
      - id: "add_small_size"
        type: "task"
        name: "Добавление размера S"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_response.id}}"
            sizeName: "S"
            countItems: 15
            price: "{{test_product.base_price}}"
        on_success:
          save_response: "variant_small"

      - id: "add_medium_size"
        type: "task"
        name: "Добавление размера M"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_response.id}}"
            sizeName: "M"
            countItems: 25
            price: "{{test_product.base_price}} * 1.1"
        on_success:
          save_response: "variant_medium"

      - id: "add_large_size"
        type: "task"
        name: "Добавление размера L"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_response.id}}"
            sizeName: "L"
            countItems: 10
            price: "{{test_product.base_price}} * 1.2"
        on_success:
          save_response: "variant_large"

  - id: "check_product_listing"
    type: "task"
    name: "Проверка листинга товара"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/products/{{product_response.id}}"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "product_details"

  - id: "check_availability"
    type: "task"
    name: "Проверка доступности"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/products/{{product_response.id}}/availability"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "availability_info"

  - id: "check_stock_levels"
    type: "task"
    name: "Проверка уровней запасов"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/product-infos/product/{{product_response.id}}"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "stock_info"

  - id: "generate_product_report"
    type: "task"
    name: "Генерация отчета по товару"
    config:
      module: "FpLab4.Steps.ReportStep"
      function: "generate_product_report"
      inputs:
        product_id: "{{product_response.id}}"
        product_details: "{{product_details}}"
        variants:
          - "{{variant_small}}"
          - "{{variant_medium}}"
          - "{{variant_large}}"
        availability: "{{availability_info}}"
        stock: "{{stock_info}}"
    on_success:
      save_result: "product_report"