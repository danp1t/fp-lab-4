name: "Add Product to Store"
include_configs:
  - "workflows/configs/api_config.yaml"
  - "workflows/configs/test_data.yaml"

steps:
  check_permissions:
    type: task
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/accounts/{{account_id}}/detail"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "user_details"

  create_product:
    type: task
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "POST"
      url: "{{base_url}}/api/products"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
      body:
        name: "{{test_product.name}} #{timestamp}"
        description: "{{test_product.description}}"
        category: "{{test_product.category}}"
        basePrice: "{{test_product.base_price}}"
        popularity: 0
    on_success:
      save_product_id: "product_id"

  add_product_variants:
    type: parallel
    steps:
      add_small_size:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_id}}"
            sizeName: "S"
            countItems: 15
            price: "{{test_product.base_price}}"
        on_success:
          save_response: "variant_small"

      add_medium_size:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_id}}"
            sizeName: "M"
            countItems: 25
            price: "{{test_product.base_price}} * 1.1"
        on_success:
          save_response: "variant_medium"

      add_large_size:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/product-infos"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            productId: "{{product_id}}"
            sizeName: "L"
            countItems: 10
            price: "{{test_product.base_price}} * 1.2"
        on_success:
          save_response: "variant_large"

  verify_product_creation:
    type: sequential
    steps:
      check_product_listing:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/products/{{product_id}}"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "product_details"

      check_availability:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/products/{{product_id}}/availability"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "availability_info"

      check_stock_levels:
        type: task
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/product-infos/product/{{product_id}}"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "stock_info"

  generate_product_report:
    type: task
    config:
      module: "FpLab4.Steps.ReportStep"
      function: "generate_product_report"
      inputs:
        product_id: "{{product_id}}"
        product_details: "{{product_details}}"
        variants:
          - "{{variant_small}}"
          - "{{variant_medium}}"
          - "{{variant_large}}"
        availability: "{{availability_info}}"
        stock: "{{stock_info}}"
    on_success:
      save_result: "product_report"

  notify_team:
    type: task
    config:
      module: "FpLab4.Steps.NotificationStep"
      function: "send_product_added_notification"
      report: "{{product_report}}"
      recipients:
        - "inventory@example.com"
        - "sales@example.com"
