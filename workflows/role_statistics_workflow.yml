name: "Статистика по ролям пользователей"
include_configs:
  - "workflows/configs/api_config.yaml"

steps:
  - id: "load_all_accounts"
    type: "task"
    name: "Загрузка всех аккаунтов"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/accounts"
      headers:
        Authorization: "Bearer {{admin_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "all_accounts"

  - id: "analyze_accounts"
    type: "parallel"
    name: "Анализ аккаунтов"
    steps:
      - id: "count_total_users"
        type: "task"
        name: "Количество пользователей"
        config:
          module: "FpLab4.Steps.StatisticsStep"
          function: "count_items"
          input: "{{all_accounts}}"
          item_name: "users"
        on_success:
          save_result: "total_users"

      - id: "get_users_by_email"
        type: "task"
        name: "Фильтрация по email"
        config:
          module: "FpLab4.Steps.StatisticsStep"
          function: "filter_by_field"
          input: "{{all_accounts}}"
          field: "email"
          value: "example"
        on_success:
          save_result: "example_users"

      - id: "get_group_by_name"
        type: "task"
        name: "Группировка по имени"
        config:
          module: "FpLab4.Steps.StatisticsStep"
          function: "group_by_date"
          input: "{{all_accounts}}"
          date_field: "name"  
          interval: "month"
        on_success:
          save_result: "name_groups"

  - id: "get_accounts_with_roles"
    type: "parallel"
    name: "Получение аккаунтов с ролями"
    steps:
      - id: "get_account_details_1"
        type: "task"
        name: "Детали аккаунта 1"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/accounts/{{all_accounts[0].id}}/detail"
          headers:
            Authorization: "Bearer {{admin_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "account_details_1"

      - id: "get_account_details_2"
        type: "task"
        name: "Детали аккаунта 2"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/accounts/{{all_accounts[1].id}}/detail"
          headers:
            Authorization: "Bearer {{admin_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "account_details_2"

      - id: "get_account_details_3"
        type: "task"
        name: "Детали аккаунта 3"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "GET"
          url: "{{base_url}}/api/accounts/{{all_accounts[2].id}}/detail"
          headers:
            Authorization: "Bearer {{admin_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "account_details_3"

  - id: "analyze_role_distribution"
    type: "task"
    name: "Анализ распределения ролей"
    config:
      module: "FpLab4.Steps.StatisticsStep"
      function: "extract_roles"
      inputs:
        - "{{account_details_1}}"
        - "{{account_details_2}}"
        - "{{account_details_3}}"
    on_success:
      save_result: "role_samples"

  - id: "generate_role_report"
    type: "task"
    name: "Генерация отчета по ролям"
    config:
      module: "FpLab4.Steps.ReportStep"
      function: "generate_role_report"
      inputs:
        total_users: "{{total_users}}"
        example_users_count: "{{example_users|length}}"
        name_groups: "{{name_groups}}"
        role_samples: "{{role_samples}}"
    on_success:
      save_result: "role_report"

  - id: "export_statistics"
    type: "parallel"
    name: "Экспорт статистики"
    steps:
      - id: "save_to_json"
        type: "task"
        name: "Сохранение в JSON"
        config:
          module: "FpLab4.Steps.ExportStep"
          function: "save_json"
          data: "{{role_report}}"
          filename: "role_statistics_#{timestamp}.json"

      - id: "print_summary"
        type: "task"
        name: "Вывод сводки"
        config:
          module: "FpLab4.Steps.DisplayStep"
          function: "print_summary"
          report: "{{role_report}}"