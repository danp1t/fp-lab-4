name: "Добавление поста в ленту"
include_configs:
  - "workflows/configs/api_config.yaml"
  - "workflows/configs/test_data.yaml"

steps:
  - id: "prepare_post_content"
    type: "task"
    name: "Подготовка контента поста"
    config:
      module: "FpLab4.Steps.ContentStep"
      function: "generate_post_content"
      parameters:
        title_template: "{{test_post.title}} - #{timestamp}"
        text: "{{test_post.text}}"
        tags:
          - "news"
          - "update"
          - "announcement"
    on_success:
      save_result: "post_content"

  - id: "create_post"
    type: "task"
    name: "Создание поста"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "POST"
      url: "{{base_url}}/api/posts"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
      body:
        title: "{{post_content.title}}"
        text: "{{post_content.text}}"
        ownerId: "{{test_post.owner_id}}"
        tags: "{{post_content.tags}}"
    on_success:
      save_response: "post_response"

  - id: "enhance_post"
    type: "parallel"
    steps:
      - id: "add_attachment"
        type: "task"
        name: "Добавление вложения"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/attachments"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            postId: "{{post_response.id}}"
            name: "post_image.jpg"
            path: "/uploads/post_#{timestamp}.jpg"
            typeAttachmentId: 1
        on_success:
          save_response: "attachment_info"

      - id: "add_initial_like"
        type: "task"
        name: "Добавление начального лайка"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/posts/{{post_response.id}}/like"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
        on_success:
          save_response: "like_info"

      - id: "add_first_comment"
        type: "task"
        name: "Добавление первого комментария"
        config:
          module: "FpLab4.Steps.HttpStep"
          method: "POST"
          url: "{{base_url}}/api/comments"
          headers:
            Authorization: "Bearer {{auth_token}}"
            Content-Type: "application/json"
          body:
            userComment: "Опа. Пост создан с помощью оркестратора."
            postId: "{{post_response.id}}"
            accountId: "{{test_post.owner_id}}"
            createdAt: "#{current_datetime}"
        on_success:
          save_response: "comment_info"

  - id: "check_post_visibility"
    type: "task"
    name: "Проверка видимости поста"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/posts/{{post_response.id}}"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "published_post"

  - id: "check_feed_inclusion"
    type: "task"
    name: "Проверка включения в ленту"
    config:
      module: "FpLab4.Steps.HttpStep"
      method: "GET"
      url: "{{base_url}}/api/posts"
      headers:
        Authorization: "Bearer {{auth_token}}"
        Content-Type: "application/json"
    on_success:
      save_response: "current_feed"

  - id: "analyze_post_performance"
    type: "task"
    name: "Анализ производительности поста"
    config:
      module: "FpLab4.Steps.AnalyticsStep"
      function: "analyze_post_engagement"
      inputs:
        post_data: "{{published_post}}"
        feed_data: "{{current_feed}}"
        interactions:
          likes: "{{like_info}}"
          comments: "{{comment_info}}"
          attachments: "{{attachment_info}}"
    on_success:
      save_result: "post_analytics"